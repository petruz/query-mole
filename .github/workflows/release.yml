name: Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0

jobs:
  build-and-release:
    name: Build and Release
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # Required for creating releases
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: Install frontend dependencies
      working-directory: ./frontend
      run: npm ci
      
    - name: Build frontend
      working-directory: ./frontend
      run: npm run build
      
    - name: Copy frontend to backend resources
      run: |
        rm -rf backend/src/main/resources/static
        mkdir -p backend/src/main/resources/static
        cp -r frontend/dist/* backend/src/main/resources/static/
        
    - name: Grant execute permission for gradlew
      working-directory: ./backend
      run: chmod +x gradlew
      
    - name: Build backend JAR
      working-directory: ./backend
      run: ./gradlew clean bootJar
      
    - name: Rename JAR for release
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        mv backend/build/libs/backend-0.0.1-SNAPSHOT.jar query-mole-${VERSION}.jar
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: query-mole-*.jar
        body: |
          ## üöÄ Query Mole ${{ github.ref_name }}
          
          ### üì¶ Download and Run
          ```bash
          java -jar query-mole-${{ github.ref_name }}.jar
          ```
          
          ### üåê Access
          Open your browser at: `http://localhost:8080`
          
          ### ‚ú® Features
          - Embedded frontend and backend in a single JAR
          - No separate server setup needed
          - Cross-platform (Windows, macOS, Linux)
          
          ### üìã Requirements
          - Java 17 or higher
        generate_release_notes: true
